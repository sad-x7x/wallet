"use strict";(self.webpackChunkmytonwallet=self.webpackChunkmytonwallet||[]).push([[432],{45232:(e,t,n)=>{n.d(t,{J5:()=>d});var r=n(31481),o=n(39989),a=n(55029),s=n(37836);const i=3e4;async function d(e,t,n){const{retries:d=r.TUC,timeouts:u=r.cSq,shouldSkipRetryFn:p=c}=null!=n?n:{};let f,w="Unknown error.";for(let n=1;n<=d;n++)try{var m;n>1&&(0,a.MD)(`Retry request #${n}:`,e.toString(),f);const r=Array.isArray(u)?null!==(m=u[n-1])&&void 0!==m?m:u[u.length-1]:Math.min(u*n,i),o=await l(e,t,r);if(f=o.status,f>=400){const{error:e}=await o.json().catch((()=>{}));throw new Error(null!=e?e:`HTTP Error ${f}`)}return o}catch(e){var A;if(w="string"==typeof e?e:null!==(A=e.message)&&void 0!==A?A:w,p(w,f))throw new o.K$(w,f);n<d&&await(0,s.v7)(r.WRE*n)}throw new o.K$(w)}async function l(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:r.cSq;const o=new AbortController,a=setTimeout((()=>{o.abort()}),n);try{return await fetch(e,{...t,signal:o.signal,cache:"no-cache"})}finally{clearTimeout(a)}}function c(e,t){return t&&[400,404].includes(t)}},95683:(e,t,n)=>{n.r(t),n.d(t,{buildLedgerTokenTransfer:()=>Re,checkTonApp:()=>Se,connectLedger:()=>he,detectAvailableTransports:()=>ge,getLedgerWalletAddress:()=>qe,getLedgerWalletInfo:()=>We,getNextLedgerWallets:()=>Ne,getTonAppInfo:()=>_e,importLedgerWallet:()=>ye,reconnectLedger:()=>ve,signLedgerProof:()=>Be,signLedgerTransactions:()=>Ee,submitLedgerNftTransfer:()=>Pe,submitLedgerStake:()=>Te,submitLedgerStakingClaim:()=>Ie,submitLedgerTransfer:()=>Le,submitLedgerUnstake:()=>ke,verifyAddress:()=>De,waitLedgerTonApp:()=>be});var r=n(24450),o=n(68238),a=n(7416),s=n(1307),i=n(34557),d=n(3512),l=n(65871),c=n(66902),u=n(14568),p=n(23174),f=n(31481),w=n(25379),m=n(3476),A=n(94471),g=n(90746),y=n(3273),v=n(71902),h=n(99579),S=n(79145),b=n(28784),T=n(7941),k=n(8387),I=(n(67491),n(55029)),L=n(69780),P=n(97935),R=n(61995),C=n(84752),M=n(86972),E=n(67132),B=n(48287).Buffer;n(809);var N=n(77744),W=n(48287).Buffer;const q=127;let D;function O(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mainnet";return D||(D={mainnet:new N.x({endpoint:`${f._J8}/api/v2/jsonRPC`,timeout:f.cSq,apiKey:f.Irq,headers:(void 0).apiHeaders}),testnet:new N.x({endpoint:`${f.pyR}/api/v2/jsonRPC`,timeout:f.cSq,apiKey:f.HGV,headers:(void 0).apiHeaders})}),D[e]}function U(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:m.e2,n=arguments.length>2?arguments[2]:void 0;return"string"==typeof e&&(e=s.Address.parse(e)),e.toString({urlSafe:!0,bounceable:t,testOnly:"testnet"===n})}function F(e,t){return(new s.Builder).storeUint(Number(e),1).storeUint(Number(t),1).asCell()}function _(e,t){const n=s.Dictionary.empty(s.Dictionary.Keys.Address(),s.Dictionary.Values.Bool());for(const t of e)n.set(s.Address.parse(t),!0);return(0,s.beginCell)().storeUint(R.Hx.CLAIM_REWARDS,32).storeUint(null!=t?t:0,64).storeDict(n,s.Dictionary.Keys.Address(),s.Dictionary.Values.Bool()).endCell()}A.m,g.t,y.A,v.H,h.a,S.G,b.N,T.U,k.WalletContractV5R1,(0,L.A)((async(e,t,n)=>{const r=O(e).open(new P.Sr(s.Address.parse(n)));return U(await r.getWalletAddress(s.Address.parse(t)),!0,e)})),(0,L.A)((async(e,t)=>{const n=O(e).open(new E.K(s.Address.parse(t)));return U((await n.getWalletData()).minter,!0,e)})),(0,L.A)((async(e,t)=>{try{const r=(await O(e).callGetMethod(s.Address.parse(t),"get_public_key")).stack.readBigNumber();return n=r.toString(16).padStart(64,"0"),Uint8Array.from(B.from(n,"hex"))}catch(e){return void(0,I.SJ)("getWalletPublicKey",e)}var n})),(0,L.A)((async(e,t,n,r)=>{const o=O(e),a=o.open(M.Ml.createFromAddress(s.Address.parse(t))),i=await a.getWalletAddress(s.Address.parse(r),n);return o.open(C.sH.createFromAddress(i))}));var J=n(39989),x=n(86243);function H(e,t){const n=e.split(".").map(Number),r=t.split(".").map(Number);for(let e=0;e<Math.max(n.length,r.length);e++){const t=n[e]||0,o=r[e]||0;if(t>o)return 1;if(t<o)return-1}return 0}var K=n(37836),j=n(82393),V=n(99544),G=n(48287).Buffer,Y=function(e){return e.v3R2="v3r2",e.v4R2="v4",e}(Y||{});const $=0,z="v4R2",Q=10,Z=125,X=!1,ee="2.1.0",te="2.2.0",ne=268,re=i._t.map((e=>{let{masterAddress:t}=e;return t.toString({bounceable:!0,urlSafe:!0})}));let oe,ae,se,ie,de,le,ce,ue,pe=!1,fe=!1,we=!1;async function me(){if(f.UMQ)return de||(de=Promise.all([n.e(580),n.e(513),n.e(642)]).then(n.bind(n,17642)).then((e=>e.BleConnector)),le=await de),de}async function Ae(){if(j.xy){if(!ie){ie=Promise.all([n.e(580),n.e(232)]).then(n.bind(n,84232)).then((e=>({transport:e.HIDTransport,listLedgerDevices:e.listLedgerDevices})));const e=await ie;ce=e.transport,ue=e.listLedgerDevices}return ie}}async function ge(){return await me(),await Ae(),[pe,we,fe]=await Promise.all([j.xy?ce.isSupported():o.A.isSupported(),le?le.isSupported():Promise.resolve(!1),a.A.isSupported()]),{isUsbAvailable:pe||fe,isBluetoothAvailable:we}}async function ye(e,t){const n=await We(e,t);return(0,w.p)("importLedgerWallet",e,n)}async function ve(){try{var e;if(await(null===(e=ae)||void 0===e?void 0:e.isAppOpen()))return!0}catch{}if(!await he())return!1;try{return await be()}catch(e){if((0,V.HN)(e.name))return ve();throw e}}async function he(e){e&&(se=e);try{return"bluetooth"===se?oe=await async function(){if(!le)throw new Error("BLE is not supported on this device.");return(await le.connect()).bleTransport}():pe?oe=await(j.xy?async function(){for(let e=0;e<Q;e++){const[e]=await ue();if(e)return ce.open(e);await(0,K.v7)(Z)}throw new Error("Failed to connect")}():async function(){for(let e=0;e<Q;e++){const[e]=await o.A.list();if(e)return e.opened?new o.A(e):o.A.open(e);await o.A.create(),await(0,K.v7)(Z)}throw new Error("Failed to connect")}()):fe&&(oe=await async function(){for(let t=0;t<Q;t++){const[t]=await a.A.list();var e;if(t)return t.opened?null!==(e=await a.A.openConnected())&&void 0!==e?e:await a.A.request():a.A.open(t);await a.A.create(),await(0,K.v7)(Z)}throw new Error("Failed to connect")}()),oe?(ae=new i.vs(oe),!0):((0,I.SJ)("connectLedger: BLE and/or HID are not supported"),!1)}catch(e){return(0,I.SJ)("connectLedger",e),!1}}async function Se(){for(let r=0;r<Q;r++){try{var e,t,n;if(await(null===(e=ae)||void 0===e?void 0:e.isAppOpen()))return null!==(t=oe)&&void 0!==t&&null!==(t=t.deviceModel)&&void 0!==t&&t.id.startsWith("nanoS")&&await(null===(n=ae)||void 0===n?void 0:n.getAddress(Ue(0),{walletVersion:Y[z]})),!0}catch(e){if((0,V.HN)(e.name))throw ae=void 0,e;null!=e&&e.message.includes("0x530c")||(0,I.SJ)("waitLedgerTonApp",e)}await(0,K.v7)(Z)}return!1}function be(){return Promise.race([Se(),new Promise((e=>{setTimeout((()=>{e(!1)}),Z*Q)}))])}async function Te(e,t,n,r){const o=await(0,w.p)("fetchAddress",e,"ton");let a;const s={type:"stake"};switch(n.type){case"nominators":a=await Le({accountId:e,password:"",toAddress:n.pool,amount:t+m.sl.stakeNominators,comment:m.v8,realFee:r},f.Tu9.slug,s);break;case"liquid":{const n={type:"tonstakers-deposit",queryId:0n,appId:null};a=await Le({accountId:e,password:"",toAddress:f.qMf,amount:t+m.sl.stakeLiquid,realFee:r},f.Tu9.slug,s,n);break}case"jetton":{const{pool:o,period:i,tokenAddress:d,tokenSlug:l}=n;Object.assign(s,{inMsgHash:void 0,slug:l,toAddress:o}),a=await Le({accountId:e,password:"",toAddress:o,tokenAddress:d,amount:t,data:M.Ml.stakePayload(i),forwardAmount:m.sl.stakeJettonsForward,realFee:r},f.Tu9.slug,s);break}}return a&&await(0,w.p)("updateAccountMemoryCache",e,o,{stakedAt:Date.now()}),a}async function ke(e,t,n,r){const{network:o}=(0,x.c)(e),a=await(0,w.p)("fetchAddress",e,"ton");let i;const l={type:"unstakeRequest"};switch(t.type){case"nominators":{const n=U(t.pool,!0,o);i=await Le({accountId:e,password:"",toAddress:n,amount:m.sl.unstakeNominators,comment:m.mv,realFee:r},f.Tu9.slug,l);break}case"liquid":{const s=await(0,w.p)("resolveTokenWalletAddress",o,a,f.Kzb),c=!1,u=(t.instantAvailable?p.Dn.Default:p.Dn.BestRate)===p.Dn.BestRate,A={type:"jetton-burn",queryId:0n,amount:n,responseDestination:d.Address.parse(a),customPayload:F(c,u)};i=await Le({accountId:e,password:"",toAddress:s,amount:m.sl.unstakeLiquid,realFee:r},f.Tu9.slug,l,A);break}case"jetton":{const{stakeWalletAddress:o}=t,a={type:"unsafe",message:(c=n,u=!0,(0,s.beginCell)().storeUint(R.Hx.UNSTAKE_JETTONS,32).storeUint(0,64).storeCoins(c).storeBit(u).endCell())};i=await Le({accountId:e,password:"",toAddress:o,amount:m.sl.unstakeJettons,realFee:r},f.Tu9.slug,l,a);break}}var c,u;return i}function Ie(e,t,n){const r={type:"unsafe",message:_(t.poolWallets)};return Le({accountId:e,amount:m.sl.claimJettons,password:"",toAddress:t.stakeWalletAddress,realFee:n},f.Tu9.slug,void 0,r)}async function Le(e,t,n,r){const{accountId:o,tokenAddress:a,comment:s,realFee:i,data:l,forwardAmount:c}=e;let{toAddress:f,amount:A}=e;const{network:g}=(0,x.c)(o),y=await(0,w.p)("waitAndCreateTonPendingTransfer",o),v=await(0,w.p)("fetchAddress",o,"ton"),[h,S,b,T]=await Promise.all([Oe(o),(0,w.p)("getWalletInfo",g,v),_e(),(0,w.p)("fetchLedgerAccount",o)]),{seqno:k,balance:L}=S,P=d.Address.parseFriendly(f);let R=P.isBounceable;const C=P.address.toString({urlSafe:!0,bounceable:m.e2}),{isUnsafeSupported:M,isJettonIdSupported:E}=b;if(a)({toAddress:f,amount:A,payload:r}=await Re({network:g,tokenAddress:a,fromAddress:v,toAddress:f,amount:A,data:s||l,isJettonIdSupported:E,forwardAmount:c})),R=!0;else if(s)if((0,V.Vq)(s))r={type:"comment",text:s};else{if(!M)return{error:p.jf.NotSupportedHardwareOperation};r={type:"unsafe",message:Me(s)}}const B=a||L!==A?u.SendMode.PAY_GAS_SEPARATELY+u.SendMode.IGNORE_ERRORS:u.SendMode.CARRY_ALL_REMAINING_BALANCE,N="v3R2"===T.ton.version?{includeWalletOp:!1}:void 0;try{const a={base64:(await ae.signTransaction(h,{to:d.Address.parse(f),sendMode:B,seqno:k,timeout:Fe(),bounce:R,amount:BigInt(A),payload:r,walletSpecifiers:N})).toBoc().toString("base64"),seqno:k,params:{amount:e.amount,fromAddress:v,toAddress:C,comment:s,fee:null!=i?i:0n,slug:t,...n}};return await(0,w.p)("sendSignedTransferMessage",o,a,y)}catch(e){return await(0,w.p)("cancelPendingTransfer",y),Je(e),void(0,I.SJ)("submitLedgerTransfer",e)}}async function Pe(e){const{accountId:t,nftAddress:n,comment:r,nft:o,realFee:a}=e;let{toAddress:s}=e;const{network:i}=(0,x.c)(t),c=await(0,w.p)("waitAndCreateTonPendingTransfer",t),A=await(0,w.p)("fetchAddress",t,"ton"),[g,y,v,h]=await Promise.all([Oe(t),(0,w.p)("getWalletInfo",i,A),_e(),(0,w.p)("fetchLedgerAccount",t)]);if(!v.isUnsafeSupported)return{error:p.jf.NotSupportedHardwareOperation};const{seqno:S}=y,b=(null==o?void 0:o.collectionAddress)===f.KmP&&(s===f.pV9||f.WVU.includes(s));let T=null,k=m.Wb;b?(({forwardPayload:T,toAddress:s}=function(e,t){const n=d.Address.parse(e).hash.readUint8()>>4,r=f.WVU[n];return{forwardPayload:(new l.Builder).storeUint(1609328194,32).storeUint(t,64).endCell(),toAddress:r}}(n,o.index)),k=50000000n):r&&(T=Me(r));const L="v3R2"===h.ton.version?{includeWalletOp:!1}:void 0;try{const l={base64:(await ae.signTransaction(g,{to:d.Address.parse(n),sendMode:u.SendMode.PAY_GAS_SEPARATELY+u.SendMode.IGNORE_ERRORS,seqno:S,timeout:Fe(),bounce:!0,amount:m.uS,payload:{type:"nft-transfer",queryId:0n,newOwner:d.Address.parse(s),responseDestination:d.Address.parse(A),customPayload:null,forwardAmount:k,forwardPayload:T},walletSpecifiers:L})).toBoc().toString("base64"),seqno:S,params:{amount:m.uS,fromAddress:A,toAddress:e.toAddress,comment:r,fee:null!=a?a:0n,slug:f.Tu9.slug,type:"nftTransferred",nft:o,normalizedAddress:U(n,!0,i)}};return await(0,w.p)("sendSignedTransferMessage",t,l,c)}catch(e){return await(0,w.p)("cancelPendingTransfer",c),void(0,I.SJ)("submitLedgerNftTransfer",e)}}async function Re(e){let{network:t,tokenAddress:n,fromAddress:r,toAddress:o,amount:a,data:s,isJettonIdSupported:i,forwardAmount:l=m.tF}=e;const c=await(0,w.p)("resolveTokenWalletAddress",t,r,n);if(n!==await(0,w.p)("resolveTokenAddress",t,c))throw new Error("Invalid contract");const u="string"==typeof s?Me(s):null!=s?s:null,p={type:"jetton-transfer",queryId:0n,amount:a,destination:d.Address.parse(o),responseDestination:d.Address.parse(r),customPayload:null,forwardAmount:l,forwardPayload:u,knownJetton:i?Ce(n):null},f=await(0,w.p)("getAmountForTokenTransfer",n,!1);if(!f)throw new Error("Couldn't get the TON amount for transfer");let A=f.amount;return l>m.tF&&(A+=l),{amount:A,toAddress:c,payload:p}}function Ce(e){const t=re.indexOf(e);return t>-1?{jettonId:t,workchain:m.Zm}:null}function Me(e){const t=function(e){const t=W.from(e),n=new Uint8Array(t.length+4),r=W.alloc(4);return r.writeUInt32BE(m.$G.Comment),n.set(r,0),n.set(t,4),n}(e);return function(e){var t;const n=q;let r;for(let t=Math.ceil(e.length/n)-1;t>=0;t--){const o=t*n,a=Math.min(n,e.length-o),i=W.from(e.buffer,e.byteOffset+o,a),d=(new s.Builder).storeBuffer(i);r&&d.storeRef(r),r=d.endCell()}return null!==(t=r)&&void 0!==t?t:s.Cell.EMPTY}(t)}async function Ee(e,t,n){const{isTonConnect:r,vestingAddress:o}=null!=n?n:{},{network:a}=(0,x.c)(e),[l,p,A]=await Promise.all([Oe(e),_e(),(0,w.p)("fetchLedgerAccount",e)]),g=A.ton.address,{isUnsafeSupported:y,isJettonIdSupported:v}=p;if(r&&!y)throw new J.cp("Please update Ledger TON app.");const h=await(0,w.p)("getWalletSeqno",e,o);let S;"v3R2"===A.ton.version&&(S={includeWalletOp:!1}),o&&(S={subwalletId:ne,includeWalletOp:!1});const b=await Promise.all(t.map((async(e,t)=>{var n;const{toAddress:r,amount:o,stateInit:l,rawPayload:p}=e,f=d.Address.isFriendly(r)?d.Address.parseFriendly(r).isBounceable:m.e2;let A;if(p&&(A=(0,i.vY)(c.Cell.fromBase64(p),{disallowModification:!0})),"jetton-transfer"===(null===(n=A)||void 0===n?void 0:n.type)){const e=await(0,w.p)("resolveTokenAddress",a,r);A.knownJetton=v?Ce(e):null}const g=l?(0,s.loadStateInit)(c.Cell.fromBase64(l).asSlice()):void 0;return{to:d.Address.parse(r),sendMode:u.SendMode.PAY_GAS_SEPARATELY+u.SendMode.IGNORE_ERRORS,seqno:h+t,timeout:Fe(),bounce:f,amount:BigInt(o),payload:A,walletSpecifiers:S,stateInit:g}}))),T=[],k=Q+b.length;let L=0,P=0;for(;L<b.length&&P<k;){const e=b[L],n=t[L];try{var R;const t=(await ae.signTransaction(l,e)).toBoc().toString("base64");T.push({base64:t,seqno:e.seqno,params:{amount:n.amount,fromAddress:g,toAddress:n.toAddress,comment:"comment"===(null===(R=n.payload)||void 0===R?void 0:R.type)?n.payload.comment:void 0,fee:0n,slug:f.Tu9.slug}}),L++}catch(e){Je(e),(0,I.SJ)("signLedgerTransactions",e)}P++}return T}async function Be(e,t){const n=await Oe(e),{timestamp:r,domain:o,payload:a}=t;return(await ae.getAddressProof(n,{domain:o,timestamp:r,payload:G.from(a)})).signature.toString("base64")}async function Ne(e){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];const n=[];let r=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1)+1;try{for(;;){const o=await We(e,r);if(t.includes(o.address))r+=1;else{if(0n===o.balance)return n.length||n.push(o),n;n.push(o),r+=1}}}catch(e){return(0,J.QS)(e)}}async function We(e,t){var n,r;const{address:o,publicKey:a}=await qe(t),s=await(0,w.p)("getWalletBalance","ton",e,o);return{index:t,address:o,publicKey:a.toString("hex"),balance:s,version:z,driver:"HID",deviceId:null===(n=oe.deviceModel)||void 0===n?void 0:n.id,deviceName:null===(r=oe.deviceModel)||void 0===r?void 0:r.productName}}function qe(e,t){const n=Ue(e,t);return ae.getAddress(n,{chain:$,bounceable:m.eL,walletVersion:Y[z]})}async function De(e){const[t,n]=await Promise.all([(0,w.p)("fetchLedgerAccount",e),Oe(e)]);var r;await ae.validateAddress(n,{bounceable:X,walletVersion:(r=t.ton.version,Y[r])})}async function Oe(e){return Ue((await(0,w.p)("fetchLedgerAccount",e)).ton.index)}function Ue(e,t){return[44,607,t?1:0,-1===(arguments.length>2&&void 0!==arguments[2]?arguments[2]:m.Zm)?255:0,e,0]}function Fe(){return Math.floor(Date.now()/1e3+m.kF)}async function _e(){var e;const t=await ae.getVersion();return{version:t,isUnsafeSupported:H(t,ee)>=0,isJettonIdSupported:H(t,te)>=0&&"nanoS"!==(null===(e=oe.deviceModel)||void 0===e?void 0:e.id)}}function Je(e){if(null!=e&&e.message.includes("(0xbd00)"))throw new J.bS;if((null==e?void 0:e.statusCode)===r.StatusCodes.CONDITIONS_OF_USE_NOT_SATISFIED)throw new J.KB}me(),Ae()}}]);
//# sourceMappingURL=432.feac22f8d67028f0685a.js.map